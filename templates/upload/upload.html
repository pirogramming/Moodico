{% extends 'base.html' %} {% load static %} {% block extra_head %}
<link rel="stylesheet" href="{% static 'css/upload/upload.css' %}" />
<style>
  .image-preview-area img.color-picker-active,
  .image-preview-area canvas.color-picker-active {
    cursor: url("{% static 'images/eyedropper.svg' %}") 12 12, crosshair;
  }
</style>
{% endblock%} {% block content %}
<div class="my-item-recommendation-container">
  <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­: ì—…ë¡œë“œ ì°½ê³¼ ë§¤íŠ¸ë¦­ìŠ¤ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜ -->
  <div class="main-content-wrapper">
    <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div class="upload-section">
      <div class="search-section">
        <h2>ë‚´ ì•„ì´í…œ ê²€ìƒ‰</h2>
        <p>ë³´ìœ  ì¤‘ì¸ ë©”ì´í¬ì—… ì œí’ˆì„ ê²€ìƒ‰í•˜ê³  ì–´ìš¸ë¦¬ëŠ” ì¡°í•©ì„ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”</p>
        <div class="search-input-group">
          <input
            type="text"
            id="product-search-input"
            placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
          />
          <button type="button" id="product-search-btn">ğŸ” ê²€ìƒ‰</button>
        </div>
        <div id="search-results-box" class="search-results-box"></div>
        <div class="separator">ë˜ëŠ”</div>
        <div class="image-upload-area">
          <form
            method="POST"
            enctype="multipart/form-data"
            action="{% url 'upload_color_image' %}"
          >
            {% csrf_token %}
            <label for="image-upload-input">
              <span class="upload-icon">ğŸ“¸</span>ì‚¬ì§„ìœ¼ë¡œ ê²€ìƒ‰
              <input
                type="file"
                name="image_path"
                id="image-upload-input"
                accept="image/*"
                onchange="this.form.submit();"
              />
            </label>
          </form>
          <div id="search-product-image-area"></div>
        </div>

        <div id="image-preview-area" class="image-preview-area">
          <img
            id="uploaded-image"
            src=""
            alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€"
            style="display: none"
          />
          <canvas id="image-canvas" style="display: none"></canvas>
        </div>
        <p id="click-instruction" style="display: none">
          ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ìƒ‰ìƒì„ ì¶”ì¶œí•´ë³´ì„¸ìš”
        </p>
        <div
          id="color-display-box"
          class="color-display-box"
          style="display: none"
        >
          <div id="selected-color-swatch" class="selected-color-swatch"></div>
          <span id="hex-code-display">#FFFFFF</span>
          <button id="analyze-color-button" class="analyze-button">
            ì¶”ì²œë°›ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ë§¤íŠ¸ë¦­ìŠ¤ ì„¹ì…˜ -->
    <div class="matrix-section">
      <section class="color-matrix-container">
        <div class="quadrant-grid">
          <div class="quadrant top-left"></div>
          <div class="quadrant top-right"></div>
          <div class="quadrant bottom-left"></div>
          <div class="quadrant bottom-right"></div>
        </div>

        <div class="axis-label top-label">Light</div>
        <div class="axis-label bottom-label">Deep</div>
        <div class="axis-label left-label">Cool</div>
        <div class="axis-label right-label">Warm</div>

        <div
          id="makeup-products-container"
          class="makeup-products-container"
        ></div>
      </section>
    </div>
  </div>

  <!-- ë™ì  ì¶”ì²œ ì œí’ˆ ì˜ì—­: ì—…ë¡œë“œ/ë§¤íŠ¸ë¦­ìŠ¤ í•˜ë‹¨ì— ë°°ì¹˜ -->
  <div class="recommendations-section">
    <h3>mood ê¸°ë°˜ ì¶”ì²œ ì œí’ˆ</h3>

    <!-- ì¹´í…Œê³ ë¦¬ë³„ ì¶”ì²œ ì œí’ˆ ìŠ¬ë¡¯ -->
    <div class="recommendation-slots">
      <!-- ë¦½ ì œí’ˆ ì¶”ì²œ ìŠ¬ë¡¯ -->
      <div class="recommendation-slot">
        <div class="slot-header">
          <h4>ğŸ’‹ ë¦½ ì œí’ˆ</h4>
          <span class="product-count">0ê°œ</span>
        </div>
        <div
          id="lip-recommendation-box"
          class="recommendation-box category-box"
        >
          <div class="empty-state">
            <p>ìƒ‰ìƒì„ ë¶„ì„í•˜ë©´ ë¦½ ì œí’ˆì„ ì¶”ì²œí•´ë“œë ¤ìš”</p>
          </div>
        </div>
      </div>

      <!-- ë¸”ëŸ¬ì…” ì œí’ˆ ì¶”ì²œ ìŠ¬ë¡¯ -->
      <div class="recommendation-slot">
        <div class="slot-header">
          <h4>ğŸŒ¸ ë¸”ëŸ¬ì…”</h4>
          <span class="product-count">0ê°œ</span>
        </div>
        <div
          id="blush-recommendation-box"
          class="recommendation-box category-box"
        >
          <div class="empty-state">
            <p>ìƒ‰ìƒì„ ë¶„ì„í•˜ë©´ ë¸”ëŸ¬ì…”ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”</p>
          </div>
        </div>
      </div>

      <!-- ì•„ì´ì„€ë„ìš° ì œí’ˆ ì¶”ì²œ ìŠ¬ë¡¯ -->
      <div class="recommendation-slot">
        <div class="slot-header">
          <h4>ğŸ‘€ ì•„ì´ì„€ë„ìš°</h4>
          <span class="product-count">0ê°œ</span>
        </div>
        <div
          id="eyeshadow-recommendation-box"
          class="recommendation-box category-box"
        >
          <div class="empty-state">
            <p>ìƒ‰ìƒì„ ë¶„ì„í•˜ë©´ ì•„ì´ì„€ë„ìš°ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¶”ì²œ ì œí’ˆ ì„¹ì…˜: í•˜ë‹¨ì— ë°°ì¹˜ -->
  <div class="recommendations-section">
    <h3>ì¶”ì²œ ì œí’ˆ</h3>
    <div class="product-list">
      {% for product in search_results %}
      <div class="product-card">
        <img src="{{ product.image }}" alt="{{ product.name }}" />
        <div class="product-info">
          <div class="brand">
            {{ product.brand }} <span class="tag">{{ product.tag }}</span>
          </div>
          <div class="name">{{ product.name }}</div>
          <div class="price">{{ product.price }}</div>
        </div>
        <button
          class="recommendation-button"
          onclick="window.open('{{ product.url }}', '_blank')"
        >
          âœ¨ ì¶”ì²œë°›ê¸°
        </button>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="{% static 'js/upload/upload.js' %}"></script>
<script src="{% static 'js/recommendation/color_analyzer.js' %}"></script>
<script>
  // ê²€ìƒ‰ ë¡œì§ & search-results-box ê´€ë ¨ ë¶€ë¶„
  const inputSearch = document.getElementById("product-search-input");
  const button = document.getElementById("product-search-btn");
  const resultsBox = document.getElementById("search-results-box");
  let selectedProduct = null;

  function analyzeSelectedProduct(product) {
    const rgb = hexToRgb(product.hex);
    const coords = calculateCoordinatesFromLAB(
      product.lab_l,
      product.lab_a,
      product.lab_b
    );
    if (coords) {
      // console.log(`Analyzed Color: ${product.hex}`);
      // console.log(`Warm-Cool: ${coords.warmCool.toFixed(2)}`);
      // console.log(`Light-Deep: ${coords.lightDeep.toFixed(2)}`);

      // ìƒ‰ìƒì„ ë§¤íŠ¸ë¦­ìŠ¤ì— í‘œì‹œ
      displayColorOnMatrix(product.hex, coords.warmCool, coords.lightDeep);

      // Send to backend
      fetch("/recommend/recommend_by_color/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          warmCool: coords.warmCool,
          lightDeep: coords.lightDeep,
          lab_l: product.lab_l,
          lab_a: product.lab_a,
          lab_b: product.lab_b,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.recommended) {
            renderRecommendations(data.recommended);
            displayRecommendationsOnMatrix(data.recommended);
          } else {
            console.warn("No recommended field in response", data);
          }
          // console.log(data.recommended);
        })
        .catch((err) => console.error("ì¶”ì²œ ì‹¤íŒ¨:", err));
    }
  }

  function fetchSearchResults(query) {
    if (!query.trim()) {
      resultsBox.style.display = "none";
      return;
    }

    fetch(`/products/search_product/?q=${encodeURIComponent(query)}`)
      .then((response) => response.json())
      .then((data) => {
        resultsBox.innerHTML = ""; // ê¸°ì¡´ ê²°ê³¼ ì‚­ì œ

        if (data.results.length > 0) {
          const ul = document.createElement("ul");
          data.results.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.brand} - ${item.name}`;
            li.addEventListener("click", () => {
              inputSearch.value = `${item.name}`;
              resultsBox.style.display = "none";
              selectedProduct = item;
              analyzeSelectedProduct(item);

              // ì„ íƒí•œ ì œí’ˆì˜ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€
              const searchImageInput =
                document.getElementById("uploaded-image");
              const canvas = document.getElementById("image-canvas");

              if (searchImageInput && canvas) {
                // ê¸°ì¡´ ì…ë ¥ ì´ˆê¸°í™”
                searchImageInput.src = "";
                //searchImageInput.style.display = "none";
                // ê¸°ì¡´ ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                const context = canvas.getContext("2d");
                context.clearRect(0, 0, canvas.width, canvas.height);

                const proxyUrl = `/upload/proxy_image/?url=${encodeURIComponent(
                  item.image
                )}`;
                drawImageToCanvas(proxyUrl);

                const selectedColorSwatch = document.getElementById(
                  "selected-color-swatch"
                );
                const hexCodeDisplay =
                  document.getElementById("hex-code-display");
                selectedColorSwatch.style.backgroundColor = item.hex;
                hexCodeDisplay.textContent = item.hex;
              }
            });
            ul.appendChild(li);
          });
          resultsBox.appendChild(ul);
          resultsBox.style.display = "block";
        } else {
          resultsBox.innerHTML =
            '<p style="padding:8px">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          resultsBox.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", error);
        resultsBox.style.display = "none";
      });
  }

  // ìë™ ê²€ìƒ‰ ëª©ë¡ ê¸°ëŠ¥ (keyup)
  function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
  } // 300ms ë™ì•ˆ ì¶”ê°€ ì…ë ¥ì´ ì—†ì„ ë•Œ í˜¸ì¶œ - APIì˜ ë¶ˆí•„ìš”í•œ í˜¸ì¶œ ë°©ì§€
  inputSearch.addEventListener(
    "keyup",
    debounce((e) => {
      const query = e.target.value;
      selectedProduct = null;
      fetchSearchResults(query);
    }, 300)
  );

  // ê²€ìƒ‰ ê²°ê³¼ ê¸°ëŠ¥
  button.addEventListener("click", () => {
    const currentInput = inputSearch.value.trim();
    const expectedInput = selectedProduct ? `${selectedProduct.name}` : "";

    if (selectedProduct && currentInput === expectedInput) {
      analyzeSelectedProduct(selectedProduct);
    } else {
      alert("ì œí’ˆì„ ëª©ë¡ì—ì„œ ì •í™•íˆ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }
  });

  inputSearch.addEventListener("focus", () => {
    resultsBox.style.display = "none";
    inputSearch.select();
  });

  // search-results-box ìˆ¨ê¸°ê¸°
  document.addEventListener("click", (e) => {
    if (!resultsBox.contains(e.target) && e.target !== inputSearch) {
      resultsBox.style.display = "none";
    }
  });
</script>
{% if uploaded_image_url %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof drawImageToCanvas === "function") {
      drawImageToCanvas("{{ uploaded_image_url }}");
    }
  });
</script>
{% endif %} {% endblock %}
