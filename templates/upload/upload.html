{% extends 'base.html' %} {% load static %} {% block extra_head %}
<link rel="stylesheet" href="{% static 'css/upload/upload.css' %}" />
<style>
  .image-preview-area img.color-picker-active,
  .image-preview-area canvas.color-picker-active {
    cursor: url("{% static 'images/eyedropper.svg' %}") 12 12, crosshair;
  }
</style>
{% endblock%} {% block content %}
<div class="my-item-recommendation-container">
  <!-- 메인 콘텐츠 영역: 업로드 창과 매트릭스를 나란히 배치 -->
  <div class="main-content-wrapper">
    <!-- 업로드 섹션 -->
    <div class="upload-section">
      <div class="search-section">
        <h2>내 아이템 검색</h2>
        <p>보유 중인 메이크업 제품을 검색하고 어울리는 조합을 추천받아보세요</p>
        <div class="search-input-group">
          <input
            type="text"
            id="product-search-input"
            placeholder="제품명을 입력하세요"
          />
          <button type="button" id="product-search-btn">🔍 검색</button>
        </div>
        <div id="search-results-box" class="search-results-box"></div>
        <div class="separator">또는</div>
        <div class="image-upload-area">
          <form
            method="POST"
            enctype="multipart/form-data"
            action="{% url 'upload_color_image' %}"
          >
            {% csrf_token %}
            <label for="image-upload-input">
              <span class="upload-icon">📸</span>사진으로 검색
              <input
                type="file"
                name="image_path"
                id="image-upload-input"
                accept="image/*"
                onchange="this.form.submit();"
              />
            </label>
          </form>
          <div id="search-product-image-area"></div>
        </div>

        <div id="image-preview-area" class="image-preview-area">
          <img
            id="uploaded-image"
            src=""
            alt="업로드된 이미지"
            style="display: none"
          />
          <canvas id="image-canvas" style="display: none"></canvas>
        </div>
        <p id="click-instruction" style="display: none">
          이미지를 클릭하여 색상을 추출해보세요
        </p>
        <div
          id="color-display-box"
          class="color-display-box"
          style="display: none"
        >
          <div id="selected-color-swatch" class="selected-color-swatch"></div>
          <span id="hex-code-display">#FFFFFF</span>
          <button id="analyze-color-button" class="analyze-button">
            추천받기
          </button>
        </div>
      </div>
    </div>

    <!-- 매트릭스 섹션 -->
    <div class="matrix-section">
      <section class="color-matrix-container">
        <div class="quadrant-grid">
          <div class="quadrant top-left"></div>
          <div class="quadrant top-right"></div>
          <div class="quadrant bottom-left"></div>
          <div class="quadrant bottom-right"></div>
        </div>

        <div class="axis-label top-label">Light</div>
        <div class="axis-label bottom-label">Deep</div>
        <div class="axis-label left-label">Cool</div>
        <div class="axis-label right-label">Warm</div>

        <div
          id="makeup-products-container"
          class="makeup-products-container"
        ></div>

        <!--유사 무드 제품 추천 구간 표시-->
        <!--
        <div id="mood-selection-area" class="mood-selection-area">
          <span class="mood-label">추천 구간</span>
          <div class="resizer top-left-resizer"></div>
          <div class="resizer top-right-resizer"></div>
          <div class="resizer bottom-left-resizer"></div>
          <div class="resizer bottom-right-resizer"></div>
        </div>
        -->
      </section>
    </div>
  </div>

  <!-- 동적 추천 제품 영역: 업로드/매트릭스 하단에 배치 -->
  <div class="recommendations-section">
    <h3>mood 기반 추천 제품</h3>
    <div id="recommendation-box" class="recommendation-box">
      <div class="wave-loader">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
      </div>
    </div>
  </div>

  <!-- 추천 제품 섹션: 하단에 배치 -->
  <div class="recommendations-section">
    <h3>추천 제품</h3>
    <div class="product-list">
      {% if search_results %} 
        {% for product in search_results %}
        {% comment %} <div
          class="product-card"
          data-product-id="{{ product.brand|slugify }}-{{ product.name|slugify }}-{{ product.price|slugify }}-search{{ forloop.counter }}"
        >  {% endcomment %}
        <div class="product-card">
          {% comment %} <button class="like-button" title="좋아요"></button>
          <span class="like-count">0</span> {% endcomment %}
          <img src="{{ product.image }}" alt="{{ product.name }}" />
          <div class="product-info">
            <div class="brand">
              {{ product.brand }} <span class="tag">{{ product.tag }}</span>
            </div>
            <div class="name">{{ product.name }}</div>
            <div class="price">{{ product.price }}</div>
          </div>
          <button 
            class="recommendation-button" 
            onclick="window.open('{{ product.url }}', '_blank')"
          >
            ✨ 추천받기
          </button>
        </div>
        {% endfor %} 
      {% else %}
      <div
        class="product-card"
        data-product-id="peripera-glow-check-blusher-18000"
      >
        <button class="like-button" title="좋아요"></button>
        <span class="like-count">0</span>
        <img
          src="/static/images/test.jpg"
          alt="페리페라 글로우 체크 블러셔"
        />
        <div class="product-info">
          <div class="brand">PERIPERA <span class="tag">glossy</span></div>
          <div class="name">글로우 체크 블러셔</div>
          <div class="price">18,000원</div>
        </div>
        <button class="recommendation-button">✨ 추천받기</button>
      </div>
      <div
        class="product-card"
        data-product-id="etude-house-coating-tint-lip-12000"
      >
        <button class="like-button" title="좋아요"></button>
        <span class="like-count">0</span>
        <img
          src="{% static 'images/test.jpg' %}"
          alt="에뛰드하우스 코팅 틴트 립"
        />
        <div class="product-info">
          <div class="brand">ETUDE HOUSE <span class="tag">glossy</span></div>
          <div class="name">코팅 틴트 립</div>
          <div class="price">12,000원</div>
        </div>
        <button class="recommendation-button">✨ 추천받기</button>
      </div>
      <div
        class="product-card"
        data-product-id="innisfree-natural-eyeshadow-22000"
      >
        <button class="like-button" title="좋아요"></button>
        <span class="like-count">0</span>
        <img
          src="{% static 'images/test.jpg' %}"
          alt="이니스프리 내추럴 아이쉐도우"
        />
        <div class="product-info">
          <div class="brand">INNISFREE <span class="tag">matte</span></div>
          <div class="name">내추럴 아이쉐도우</div>
          <div class="price">22,000원</div>
        </div>
        <button class="recommendation-button">✨ 추천받기</button>
      </div>
      <div class="product-card" data-product-id="clio-earth-on-eyeshadow-32000">
        <button class="like-button" title="좋아요"></button>
        <span class="like-count">0</span>
        <img
          src="{% static 'images/test.jpg' %}"
          alt="클리오 어스 온 아이쉐도우"
        />
        <div class="product-info">
          <div class="brand">CLIO <span class="tag">matte</span></div>
          <div class="name">어스 온 아이쉐도우</div>
          <div class="price">32,000원</div>
        </div>
        <button class="recommendation-button">✨ 추천받기</button>
      </div>
      <div
        class="product-card"
        data-product-id="romand-beige-matte-lipstick-15000"
      >
        <button class="like-button" title="좋아요"></button>
        <span class="like-count">0</span>
        <img
          src="{% static 'images/test.jpg' %}"
          alt="롬앤 베이지 매트 립스틱"
        />
        <div class="product-info">
          <div class="brand">ROMAND <span class="tag">matte</span></div>
          <div class="name">베이지 매트 립스틱</div>
          <div class="price">15,000원</div>
        </div>
        <button class="recommendation-button">✨ 추천받기</button>
      </div>
      {% endif %}
    </div>
  </div> 
</div>
{% endblock %} {% block extra_js %}
<script src="{% static 'js/upload/upload.js' %}"></script>
<script src="{% static 'js/recommendation/color_analyzer.js' %}"></script>
<script>
  // 검색 로직 & search-results-box 관련 부분
  const inputSearch = document.getElementById("product-search-input");
  const button = document.getElementById("product-search-btn");
  const resultsBox = document.getElementById("search-results-box");
  let selectedProduct = null;

  function analyzeSelectedProduct(product) {
    const rgb = hexToRgb(product.hex);
    const coords = calculateCoordinatesFromLAB(
      product.lab_l,
      product.lab_a,
      product.lab_b
    );
    if (coords) {
      console.log(`Analyzed Color: ${product.hex}`);
      console.log(`Warm-Cool: ${coords.warmCool.toFixed(2)}`);
      console.log(`Light-Deep: ${coords.lightDeep.toFixed(2)}`);

      // 색상을 매트릭스에 표시
      displayColorOnMatrix(product.hex, coords.warmCool, coords.lightDeep);

      // Send to backend
      fetch("/recommend/recommend_by_color/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          warmCool: coords.warmCool,
          lightDeep: coords.lightDeep,
          lab_l: product.lab_l,
          lab_a: product.lab_a,
          lab_b: product.lab_b,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.recommended) {
            renderRecommendations(data.recommended);
            displayRecommendationsOnMatrix(data.recommended);
          } else {
            console.warn("No recommended field in response", data);
          }
          console.log(data.recommended);
        })
        .catch((err) => console.error("추천 실패:", err));
    }
  }

  function fetchSearchResults(query) {
    if (!query.trim()) {
      resultsBox.style.display = "none";
      return;
    }

    fetch(`/products/search_product/?q=${encodeURIComponent(query)}`)
      .then((response) => response.json())
      .then((data) => {
        resultsBox.innerHTML = ""; // 기존 결과 삭제

        if (data.results.length > 0) {
          const ul = document.createElement("ul");
          data.results.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.brand} - ${item.name}`;
            li.addEventListener("click", () => {
              inputSearch.value = `${item.name}`;
              resultsBox.style.display = "none";
              selectedProduct = item;
              analyzeSelectedProduct(item);

              // 선택한 제품의 이미지를 추가
              const searchImageInput =
                document.getElementById("uploaded-image");
              const canvas = document.getElementById("image-canvas");

              if (searchImageInput && canvas) {
                // 기존 입력 초기화
                searchImageInput.src = "";
                //searchImageInput.style.display = "none";
                // 기존 캔버스 초기화
                const context = canvas.getContext("2d");
                context.clearRect(0, 0, canvas.width, canvas.height);

                const proxyUrl = `/upload/proxy_image/?url=${encodeURIComponent(
                  item.image
                )}`;
                drawImageToCanvas(proxyUrl);

                const selectedColorSwatch = document.getElementById(
                  "selected-color-swatch"
                );
                const hexCodeDisplay =
                  document.getElementById("hex-code-display");
                selectedColorSwatch.style.backgroundColor = item.hex;
                hexCodeDisplay.textContent = item.hex;
              }
            });
            ul.appendChild(li);
          });
          resultsBox.appendChild(ul);
          resultsBox.style.display = "block";
        } else {
          resultsBox.innerHTML =
            '<p style="padding:8px">검색 결과가 없습니다.</p>';
          resultsBox.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("검색 오류:", error);
        resultsBox.style.display = "none";
      });
  }

  // 자동 검색 목록 기능 (keyup)
  function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
  } // 300ms 동안 추가 입력이 없을 때 호출 - API의 불필요한 호출 방지
  inputSearch.addEventListener(
    "keyup",
    debounce((e) => {
      const query = e.target.value;
      selectedProduct = null;
      fetchSearchResults(query);
    }, 300)
  );

  // 검색 결과 기능
  button.addEventListener("click", () => {
    const currentInput = inputSearch.value.trim();
    const expectedInput = selectedProduct ? `${selectedProduct.name}` : "";

    if (selectedProduct && currentInput === expectedInput) {
      analyzeSelectedProduct(selectedProduct);
    } else {
      alert("제품을 목록에서 정확히 선택해주세요.");
    }
  });

  inputSearch.addEventListener("focus", () => {
    resultsBox.style.display = "none";
    inputSearch.select();
  });

  // search-results-box 숨기기
  document.addEventListener("click", (e) => {
    if (!resultsBox.contains(e.target) && e.target !== inputSearch) {
      resultsBox.style.display = "none";
    }
  });
</script>
{% if uploaded_image_url %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof drawImageToCanvas === "function") {
      drawImageToCanvas("{{ uploaded_image_url }}");
    }
  });
</script>
{% endif %} {% endblock %}
